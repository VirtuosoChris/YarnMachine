# YarnMachine
(WIP) Standalone C++ virtual machine for Yarn Spinner.

Yarn Spinner is a neat scripting language for branching narrative that is similar to INK and is intuitive because it kind of just resembles a linear screenplay.

https://yarnspinner.dev/

This project is meant to be a standalone (non Unity, engine agnostic) C++ virtual machine and dialogue player that interprets the compiled Yarn script files.

The Github project for the original Yarn Spinner (not affiliated) can be found here:
https://github.com/YarnSpinnerTool/YarnSpinner

and an online sandbox to try the language can be found at:
https://try.yarnspinner.dev/

and the Visual Studio Code plugin (which is my preferred means of authoring scripts) can be found at :
https://marketplace.visualstudio.com/items?itemName=SecretLab.yarn-spinner

This project doesn't interpret .yarn scripts directly; it depends on 3 input files generated by the Yarn Compiler toolchain.  So you'll either need to provide these files with your game or ship the yarn compiler with your game.

1) compiled .yarnc binary files.
The compiled .yarnc files are generated as Google Protobufs
https://developers.google.com/protocol-buffers/docs/reference/cpp-generated

So protobuf is a dependency and protoc is used to generate parsing code from the original yarn_spinner.proto file that defines the Yarn Spinner bytecode format.

2 / 3) the two generated csv files containing the line database, and the metadata.
I am using the following C++ CSV parser as an additional dependency:

https://github.com/vincentlaucsb/csv-parser

Additional Notes, differences from "real" Yarn Spinner:
- All the things mentioned in the tutorial at https://docs.yarnspinner.dev/getting-started/writing-in-yarn were implemented, tested, and should work; beyond that we have serialization including deterministic RNG.
- Since this is C++ / engine agnostic, GUI / user interaction / event loops / threading / etc is bring-your-own.
- This logically includes markup parsing beyond the built-in attributes, eg. as described here:
https://docs.yarnspinner.dev/getting-started/writing-in-yarn/markup
- See the demo in main.cpp for an example of how to extend the YarnRunnerBase class with a custom dialogue runner for your game
- Built in operators and functions have been tested and implemented and should all work.
- Custom functions and markup callbacks are implemented as std::function callbacks stored in a lookup table
- The sample command binding functionality is supplied via VirtuosoConsole's QuakeStyleConsole.h 
https://github.com/VirtuosoChris/VirtuosoConsole
which can take an arbitrary c++ function and do template magic to generate type correct iostream parsers without writing any code yourself.  But you can do whatever you want with commands, like pass them to a scripting language or whatever else you want.
see instructions or main.cpp.  This also uses std::function in the implementation.
- The VM state is serializable, and uses nlohmann's c++ JSON library as a dependency to do this:
https://github.com/nlohmann/json
- Tutorials, examples, and easy dependency fetching / building to come :)
- the std::regex markup parsing should probably be replaced since std::regex is apparently not maintained and horribly slow.
It's absolutely fine for now though.
